// ==UserScript==
// @name         Generals Custom Games Helper
// @namespace    http://tampermonkey.net/
// @version      1.2
// @description  Improves your gaming experience
// @author       jwcub
// @supportURL   https://github.com/jwcub/GeneralsCustomGamesHelper
// @match        https://generals.io/*
// @require      https://cdn.bootcdn.net/ajax/libs/jquery/3.7.0/jquery.min.js
// @grant        none
// ==/UserScript==
!function(t){"use strict";function e(e){return new Promise(((n,s)=>{let a=0;const c=setInterval((()=>{const o=t(e);o.length>0&&(clearInterval(c),n(o)),a++,a>50&&(clearInterval(c),s())}),100)}))}var n=n=>{n.on("game_start",(async({options:{map:s}})=>{if(function(){if(0===document.body.children.length)return;const t=document.body.children[0];document.body.removeChild(t),document.children[0].prepend(t)}(),!s)return;let a=[];try{a=(await function(t){return fetch("/api/map?name="+t).then((t=>t.json()))}(s)).map.split(",").map((t=>t.replace(/^L_/,"")))}catch(t){return}const c=await e("#gameMap td");if(c.length!==a.length)return;function o(t){return t.toString(36)}function r(t,e){return`[class~="${o(t)}"]::before{content:"${e}"}`}function i(t){let e=a[t];const n=c[t];if("g"===e[0]){if(n.classList.contains("obstacle"))return!1;n.classList.contains("fog")||n.classList.contains("general")||(e=a[t]=" ")}if(n.classList.contains("fog")||n.classList.contains("obstacle")){n.classList.remove("fog","obstacle");const s=o(t);if(n.classList.contains(s)||n.classList.add(s),"m"===e)return n.classList.add("mountain"),"";if("s"===e)return n.classList.add("swamp"),"";if("g"===e[0])return n.classList.add("teal","general"),r(t,e.substring(1));if("n"===e[0])return n.classList.add("neutral"),r(t,e.substring(1));if(" "!==e)return n.classList.add("city"),r(t,e);n.classList.add("fog")}return!1}const l={attributes:!0};let u="";for(let t=0;t<a.length;t++){const e=i(t);!1!==e&&(u+=e,new MutationObserver((()=>setTimeout(i,100,t))).observe(c[t],l))}const m=document.createElement("style");m.innerHTML=u,t("#react-container").append(m),n.once("game_over",(()=>m.remove()))}))};var s=e=>{const n=window.location.href.match(/games\/([\s\S]*)$/)?.at(1);n&&e.on("queue_update",(({usernames:s})=>{if(t(".trigger").remove(),0!==t(".custom-host-message[style='background-color: teal;']").length)for(const a of t(".custom-team-container"))for(let c=0;c<a.children.length;c++){const o=a.children[c];if(0===c&&"Spectators"!==o.innerText)break;if(o.children.length>1)continue;const r=o.innerText,i=document.createElement("a");t(i).html('\n<svg class="hover-show" viewBox="0 0 1024 700" width="13px" height="13px" xmlns="http://www.w3.org/2000/svg"><path class="white" d="M 880.038 439.253 L 904.318 456.072 L 897.869 452.405 C 894.454 450.508 888.89 446.714 885.728 444.059 L 880.038 439.253 Z M 569.572 219.612 C 569.611 219.541 560.983 232.619 561.362 233.505 C 562.247 235.781 712.606 488.698 713.871 490.089 C 714.756 490.975 856.516 415.605 859.678 412.57 C 860.184 412.065 859.487 412.182 857.907 401.695 C 857.869 401.441 936.286 461.758 948.366 461.763 C 948.619 461.763 936.439 462.015 936.439 462.142 C 936.439 462.395 869.415 747.938 869.415 747.938 L 869.415 889.192 L 153.659 889.192 L 153.659 748.318 L 120.654 607.949 C 102.57 530.683 87.395 466.189 87.015 464.544 C 86.51 462.142 75.106 461.731 75.242 461.763 C 87.126 464.578 165.848 397.97 165.748 398.334 C 162.598 409.746 165.293 404.856 162.638 409.662 C 161.626 411.559 308.571 490.595 309.203 490.089 C 310.468 488.825 460.953 235.655 461.839 233.378 C 462.092 232.619 452.962 222.44 453.113 222.63 C 461.658 233.343 561.641 233.899 569.572 219.612 Z" style="stroke-width: 0;"></path><path class="white" d="M 504 297.2 m -82.074 0 a 82.074 82.074 0 1 0 164.148 0 a 82.074 82.074 0 1 0 -164.148 0 Z M 504 297.2 m -49.243 0 a 49.243 49.243 0 0 1 98.486 0 a 49.243 49.243 0 0 1 -98.486 0 Z" transform="matrix(0.352455, -0.935829, 0.935829, 0.352455, -370.007055, 747.229931)"></path><path class="white" d="M 504 297.2 m -82.074 0 a 82.074 82.074 0 1 0 164.148 0 a 82.074 82.074 0 1 0 -164.148 0 Z M 504 297.2 m -49.243 0 a 49.243 49.243 0 0 1 98.486 0 a 49.243 49.243 0 0 1 -98.486 0 Z" transform="matrix(0.352455, -0.935829, 0.935829, 0.352455, 481.352607, 746.899791)"></path><path class="white" d="M 504 297.2 m -82.074 0 a 82.074 82.074 0 1 0 164.148 0 a 82.074 82.074 0 1 0 -164.148 0 Z M 504 297.2 m -49.243 0 a 49.243 49.243 0 0 1 98.486 0 a 49.243 49.243 0 0 1 -98.486 0 Z" transform="matrix(0.352455, -0.935829, 0.935829, 0.352455, 55.318002, 530.920357)"></path><circle class="white" cx="86.928" cy="376.918" r="66.167"></circle><circle class="white" cx="518.083" cy="166.811" r="66.564"></circle><circle class="white" cx="944.862" cy="379.106" r="64.369"></circle></svg><span class="inline-color-block hover-false white"></span>\n').addClass("inline-color-block-hover trigger").css("display","inline-block").css("width","10px").on("click",(()=>{e.emit("set_custom_host",n,s.indexOf(r))})),o.prepend(i)}}))};const a=setInterval((()=>{window.location.href.startsWith("https://generals.io/games/")&&socket&&(clearInterval(a),console.log("plugin entry"),(e=>{function n(){t("#custom-queue-ad-top > div, #custom-queue-ad > div, #custom-queue-ad-skyscraper > div").remove()}n(),e.on("queue_update",n)})(socket),s(socket),n(socket),(e=>{let n="";function s(){n=t(".chat-messages-container").html()}function a(){t(".chat-messages-container").prepend(n),n=""}e.on("pre_game_start",s).on("game_start",(()=>{e.once("chat_message",a)})).on("game_over",(()=>{s(),e.on("chat_message",s).once("queue_update",(()=>{e.off("chat_message",s),a()}))}))})(socket),(t=>{t.on("game_lost",(()=>{e("button:contains('Spectate')").then((t=>t.click()))})).on("game_over",(()=>{e("button:contains('Play Again')").then((t=>t.click()))}))})(socket))}),1e3)}($);

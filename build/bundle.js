// ==UserScript==
// @name         Generals Custom Games Helper
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  Improves your gaming experience
// @author       jwcub
// @supportURL   https://github.com/jwcub/GeneralsCustomGamesHelper
// @match        https://generals.io/*
// @require      https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js
// @grant        none
// ==/UserScript==
!function(e){"use strict";var t=t=>{t.on("game_start",(async({options:{map:s}})=>{if(function(){if(0===document.body.children.length)return;const e=document.body.children[0];document.body.removeChild(e),document.children[0].prepend(e)}(),!s)return;let n=[];try{n=(await function(e){return fetch("/api/map?name="+e).then((e=>e.json()))}(s)).map.split(",").map((e=>e.replace(/^L_/,"")))}catch(e){return}const a=setInterval((()=>{const s=e("#gameMap td");if(s.length!==n.length)return;function c(e){return e.toString(36)}function o(e,t){return`[class~="${c(e)}"]::before{content:"${t}"}`}function r(e){let t=n[e];const a=s[e];if("g"===t[0]){if(a.classList.contains("obstacle"))return!1;a.classList.contains("fog")||a.classList.contains("general")||(t=n[e]=" ")}if(a.classList.contains("fog")||a.classList.contains("obstacle")){a.classList.remove("fog","obstacle");const s=c(e);if(a.classList.contains(s)||a.classList.add(s),"m"===t)return a.classList.add("mountain"),"";if("s"===t)return a.classList.add("swamp"),"";if("g"===t[0])return a.classList.add("teal","general"),o(e,t.substring(1));if("n"===t[0])return a.classList.add("neutral"),o(e,t.substring(1));if(" "!==t)return a.classList.add("city"),o(e,t);a.classList.add("fog")}return!1}clearInterval(a);const i={attributes:!0};let l="";for(let e=0;e<n.length;e++){const t=r(e);!1!==t&&(l+=t,new MutationObserver((()=>setTimeout(r,100,e))).observe(s[e],i))}const u=document.createElement("style");u.innerHTML=l,e("#react-container").append(u),t.once("game_over",(()=>u.remove()))}),500)}))};const s=setInterval((()=>{window.location.href.startsWith("https://generals.io/games/")&&socket&&(clearInterval(s),console.log("plugin entry"),(t=>{function s(){e("#custom-queue-ad-top > div, #custom-queue-ad > div, #custom-queue-ad-skyscraper > div").remove()}s(),t.on("queue_update",s)})(socket),(t=>{const s=window.location.href.match(/games\/([\s\S]*)$/)?.at(1);s&&t.on("queue_update",(({usernames:n})=>{if(e(".trigger").remove(),0!==e(".custom-host-message[style='background-color: teal;']").length)for(const a of e(".custom-team-container"))for(let c=0;c<a.children.length;c++){const o=a.children[c];if(0===c&&"Spectators"!==o.innerText)break;if(o.children.length>1)continue;const r=o.innerText,i=document.createElement("a");i.innerHTML='\n<svg class="hover-show" viewBox="0 0 1024 700" width="13px" height="13px" xmlns="http://www.w3.org/2000/svg"><path class="white" d="M 880.038 439.253 L 904.318 456.072 L 897.869 452.405 C 894.454 450.508 888.89 446.714 885.728 444.059 L 880.038 439.253 Z M 569.572 219.612 C 569.611 219.541 560.983 232.619 561.362 233.505 C 562.247 235.781 712.606 488.698 713.871 490.089 C 714.756 490.975 856.516 415.605 859.678 412.57 C 860.184 412.065 859.487 412.182 857.907 401.695 C 857.869 401.441 936.286 461.758 948.366 461.763 C 948.619 461.763 936.439 462.015 936.439 462.142 C 936.439 462.395 869.415 747.938 869.415 747.938 L 869.415 889.192 L 153.659 889.192 L 153.659 748.318 L 120.654 607.949 C 102.57 530.683 87.395 466.189 87.015 464.544 C 86.51 462.142 75.106 461.731 75.242 461.763 C 87.126 464.578 165.848 397.97 165.748 398.334 C 162.598 409.746 165.293 404.856 162.638 409.662 C 161.626 411.559 308.571 490.595 309.203 490.089 C 310.468 488.825 460.953 235.655 461.839 233.378 C 462.092 232.619 452.962 222.44 453.113 222.63 C 461.658 233.343 561.641 233.899 569.572 219.612 Z" style="stroke-width: 0;"></path><path class="white" d="M 504 297.2 m -82.074 0 a 82.074 82.074 0 1 0 164.148 0 a 82.074 82.074 0 1 0 -164.148 0 Z M 504 297.2 m -49.243 0 a 49.243 49.243 0 0 1 98.486 0 a 49.243 49.243 0 0 1 -98.486 0 Z" transform="matrix(0.352455, -0.935829, 0.935829, 0.352455, -370.007055, 747.229931)"></path><path class="white" d="M 504 297.2 m -82.074 0 a 82.074 82.074 0 1 0 164.148 0 a 82.074 82.074 0 1 0 -164.148 0 Z M 504 297.2 m -49.243 0 a 49.243 49.243 0 0 1 98.486 0 a 49.243 49.243 0 0 1 -98.486 0 Z" transform="matrix(0.352455, -0.935829, 0.935829, 0.352455, 481.352607, 746.899791)"></path><path class="white" d="M 504 297.2 m -82.074 0 a 82.074 82.074 0 1 0 164.148 0 a 82.074 82.074 0 1 0 -164.148 0 Z M 504 297.2 m -49.243 0 a 49.243 49.243 0 0 1 98.486 0 a 49.243 49.243 0 0 1 -98.486 0 Z" transform="matrix(0.352455, -0.935829, 0.935829, 0.352455, 55.318002, 530.920357)"></path><circle class="white" cx="86.928" cy="376.918" r="66.167"></circle><circle class="white" cx="518.083" cy="166.811" r="66.564"></circle><circle class="white" cx="944.862" cy="379.106" r="64.369"></circle></svg><span class="inline-color-block hover-false white"></span>\n',e(i).addClass("inline-color-block-hover trigger").css("display","inline-block").css("width","10px").on("click",(()=>{t.emit("set_custom_host",s,n.indexOf(r))})),o.prepend(i)}}))})(socket),t(socket),(t=>{let s="";function n(){s=e(".chat-messages-container").html()}function a(){e(".chat-messages-container").prepend(s),s=""}t.on("pre_game_start",n).on("game_start",(()=>{t.once("chat_message",a)})).on("game_over",(()=>{n(),t.on("chat_message",n).once("queue_update",(()=>{t.off("chat_message",n),a()}))}))})(socket))}),1e3)}($);

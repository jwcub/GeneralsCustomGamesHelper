// ==UserScript==
// @name         Generals Custom Games Helper
// @namespace    http://tampermonkey.net/
// @version      1.3
// @description  Improves your gaming experience
// @author       jwcub
// @supportURL   https://github.com/jwcub/GeneralsCustomGamesHelper
// @match        https://generals.io/*
// @require      https://cdn.bootcdn.net/ajax/libs/jquery/3.7.0/jquery.min.js
// @grant        none
// ==/UserScript==
!function(e){"use strict";function t(e){return new Promise(((t,n)=>{const s=localStorage.getItem("user_id");s?e.emit("get_username",s,t):n()}))}function n(t){e(".chat-messages-container").append(`\n    <p class="chat-message server-chat-message">\n       <span class="announcement-spacer"></span>  \n       ${t}\n    </p>\n  `).scrollTop(1e8)}function s(t){return new Promise(((n,s)=>{let a=0;const c=setInterval((()=>{const o=e(t);o.length>0&&(clearInterval(c),n(o)),a++,a>50&&(clearInterval(c),s())}),100)}))}var a=t=>{t.on("game_start",(async({options:{map:n}})=>{if(function(){if(0===document.body.children.length)return;const e=document.body.children[0];document.body.removeChild(e),document.children[0].prepend(e)}(),!n)return;let a=[];try{a=(await function(e){return fetch("/api/map?name="+e).then((e=>e.json()))}(n)).map.split(",").map((e=>e.replace(/^L_/,"")))}catch(e){return}const c=await s("#gameMap td");if(c.length!==a.length)return;function o(e){return e.toString(36)}function r(e,t){return`[class~="${o(e)}"]::before{content:"${t}"}`}function i(e){let t=a[e];const n=c[e];if("g"===t[0]){if(n.classList.contains("obstacle"))return!1;n.classList.contains("fog")||n.classList.contains("general")||(t=a[e]=" ")}if(n.classList.contains("fog")||n.classList.contains("obstacle")){n.classList.remove("fog","obstacle");const s=o(e);if(n.classList.contains(s)||n.classList.add(s),"m"===t)return n.classList.add("mountain"),"";if("s"===t)return n.classList.add("swamp"),"";if("g"===t[0])return n.classList.add("teal","general"),r(e,t.substring(1));if("n"===t[0])return n.classList.add("neutral"),r(e,t.substring(1));if(" "!==t)return n.classList.add("city"),r(e,t);n.classList.add("fog")}return!1}const l={attributes:!0};let m="";for(let e=0;e<a.length;e++){const t=i(e);!1!==t&&(m+=t,new MutationObserver((()=>setTimeout(i,100,e))).observe(c[e],l))}const u=document.createElement("style");u.innerHTML=m,e("#react-container").append(u),t.once("game_over",(()=>u.remove()))}))};var c=a=>{const c=window.location.href.match(/games\/([\s\S]*)$/)?.at(1);if(!c)return;let o=!0;s(".chat-messages-container").then((()=>{n("host dump: on"),a.emit("set_custom_team",c,13)})),document.body.onkeydown=e=>{"H"===e.key.toUpperCase()&&e.target===document.body&&(e.preventDefault(),o=!o,n("host dump: "+(o?"on":"off")))},t(a).then((t=>{a.on("queue_update",(({usernames:n})=>{if(e(".trigger").remove(),0===n.indexOf(t)){o&&Promise.race([(async()=>{var e;return await(e=500,new Promise((t=>setTimeout(t,e)))),1})(),new Promise((e=>{a.once("chat_message",((t,{multiText:s})=>{e(s&&" made "===s[1]?Math.max(1,n.indexOf(s[0])):1)}))}))]).then((e=>{a.emit("set_custom_host",c,e)}));for(const t of e(".custom-team-container"))for(let s=0;s<t.children.length;s++){const o=t.children[s];if(0===s&&"Spectators"!==o.innerText)break;if(o.children.length>1)continue;const r=o.innerText,i=document.createElement("a");e(i).html('\n<svg class="hover-show" viewBox="0 0 1024 700" width="13px" height="13px" xmlns="http://www.w3.org/2000/svg"><path class="white" d="M 880.038 439.253 L 904.318 456.072 L 897.869 452.405 C 894.454 450.508 888.89 446.714 885.728 444.059 L 880.038 439.253 Z M 569.572 219.612 C 569.611 219.541 560.983 232.619 561.362 233.505 C 562.247 235.781 712.606 488.698 713.871 490.089 C 714.756 490.975 856.516 415.605 859.678 412.57 C 860.184 412.065 859.487 412.182 857.907 401.695 C 857.869 401.441 936.286 461.758 948.366 461.763 C 948.619 461.763 936.439 462.015 936.439 462.142 C 936.439 462.395 869.415 747.938 869.415 747.938 L 869.415 889.192 L 153.659 889.192 L 153.659 748.318 L 120.654 607.949 C 102.57 530.683 87.395 466.189 87.015 464.544 C 86.51 462.142 75.106 461.731 75.242 461.763 C 87.126 464.578 165.848 397.97 165.748 398.334 C 162.598 409.746 165.293 404.856 162.638 409.662 C 161.626 411.559 308.571 490.595 309.203 490.089 C 310.468 488.825 460.953 235.655 461.839 233.378 C 462.092 232.619 452.962 222.44 453.113 222.63 C 461.658 233.343 561.641 233.899 569.572 219.612 Z" style="stroke-width: 0;"></path><path class="white" d="M 504 297.2 m -82.074 0 a 82.074 82.074 0 1 0 164.148 0 a 82.074 82.074 0 1 0 -164.148 0 Z M 504 297.2 m -49.243 0 a 49.243 49.243 0 0 1 98.486 0 a 49.243 49.243 0 0 1 -98.486 0 Z" transform="matrix(0.352455, -0.935829, 0.935829, 0.352455, -370.007055, 747.229931)"></path><path class="white" d="M 504 297.2 m -82.074 0 a 82.074 82.074 0 1 0 164.148 0 a 82.074 82.074 0 1 0 -164.148 0 Z M 504 297.2 m -49.243 0 a 49.243 49.243 0 0 1 98.486 0 a 49.243 49.243 0 0 1 -98.486 0 Z" transform="matrix(0.352455, -0.935829, 0.935829, 0.352455, 481.352607, 746.899791)"></path><path class="white" d="M 504 297.2 m -82.074 0 a 82.074 82.074 0 1 0 164.148 0 a 82.074 82.074 0 1 0 -164.148 0 Z M 504 297.2 m -49.243 0 a 49.243 49.243 0 0 1 98.486 0 a 49.243 49.243 0 0 1 -98.486 0 Z" transform="matrix(0.352455, -0.935829, 0.935829, 0.352455, 55.318002, 530.920357)"></path><circle class="white" cx="86.928" cy="376.918" r="66.167"></circle><circle class="white" cx="518.083" cy="166.811" r="66.564"></circle><circle class="white" cx="944.862" cy="379.106" r="64.369"></circle></svg><span class="inline-color-block hover-false white"></span>\n').addClass("inline-color-block-hover trigger").css("display","inline-block").css("width","10px").on("click",(()=>{a.emit("set_custom_host",c,n.indexOf(r))})),o.prepend(i)}}}))}))};const o=setInterval((()=>{window.location.href.startsWith("https://generals.io/games/")&&socket&&(clearInterval(o),console.log("plugin entry"),(t=>{function n(){e("#custom-queue-ad-top > div, #custom-queue-ad > div, #custom-queue-ad-skyscraper > div").remove()}n(),t.on("queue_update",n)})(socket),c(socket),a(socket),(t=>{let n="";function s(){n=e(".chat-messages-container").html()}function a(){e(".chat-messages-container").prepend(n),n=""}t.on("pre_game_start",s).on("game_start",(()=>{t.once("chat_message",a)})).on("game_over",(()=>{s(),t.on("chat_message",s).once("queue_update",(()=>{t.off("chat_message",s),a()}))}))})(socket),(e=>{e.on("game_lost",(()=>{s("button:contains('Spectate')").then((e=>e.click()))})).on("game_over",(()=>{s("button:contains('Play Again')").then((e=>e.click()))}))})(socket))}),1e3)}($);
